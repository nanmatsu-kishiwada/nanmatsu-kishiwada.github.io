<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>令和七年度 並松町若頭 御花御芳名</title>
    
    <!-- Ionic Framework -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Google Fonts - Yuji Syuku -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Noto+Serif+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* 設定定数 */
        :root {
            --calligraphy-font: 'Yuji Syuku', 'Noto Serif JP', serif;
            --background-color: #f5f5dc;
            --paper-color: #faf0e6;
            --text-color: #2c1810;
            --red-accent: #cc3333;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            font-family: var(--calligraphy-font);
        }
        
        .search-container {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .hanaban-container {
            padding: 1rem;
            background-color: var(--background-color);
        }
        
        .hanaban-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .hanashi-card {
            background: var(--paper-color);
            border: 2px solid var(--red-accent);
            border-radius: 8px;
            padding: 1rem;
            position: relative;
            min-height: 280px;
            aspect-ratio: 3/4;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(204, 51, 51, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(204, 51, 51, 0.1) 0%, transparent 20%),
                linear-gradient(45deg, rgba(204, 51, 51, 0.05) 25%, transparent 25%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .town-name {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            text-align: center;
            font-weight: 700;
        }
        
        .person-name {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-color);
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: upright;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem auto;
            letter-spacing: 0.1em;
        }
        
        .position-title {
            font-size: 0.8rem;
            color: var(--text-color);
            text-align: center;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }
        
        .amount {
            position: absolute;
            right: 1rem;
            top: 2rem;
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-size: 1rem;
            color: var(--text-color);
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #cc3333;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .hanaban-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .hanashi-card {
                min-height: 240px;
                padding: 0.8rem;
            }
            
            .person-name {
                font-size: 1.3rem;
                height: 140px;
            }
            
            .amount {
                font-size: 0.9rem;
                top: 1.5rem;
                right: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .hanaban-grid {
                grid-template-columns: 1fr;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <ion-app>
            <ion-header>
                <ion-toolbar color="primary">
                    <ion-title>令和七年度 並松町若頭 御花御芳名</ion-title>
                </ion-toolbar>
            </ion-header>
            
            <ion-content>
                <!-- 検索フォーム -->
                <div class="search-container">
                    <div class="search-grid">
                        <ion-item>
                            <ion-label position="stacked">町名で絞り込み</ion-label>
                            <ion-select v-model="searchTown" placeholder="町名を選択">
                                <ion-select-option value="">すべて表示</ion-select-option>
                                <ion-select-option v-for="town in uniqueTowns" :key="town" :value="town">
                                    {{ town }}
                                </ion-select-option>
                            </ion-select>
                        </ion-item>
                        <ion-item>
                            <ion-label position="stacked">金額で絞り込み</ion-label>
                            <ion-select v-model="searchAmount" placeholder="金額を選択">
                                <ion-select-option value="">すべて表示</ion-select-option>
                                <ion-select-option v-for="amount in uniqueAmounts" :key="amount" :value="amount">
                                    {{ amount.toLocaleString() }}円
                                </ion-select-option>
                            </ion-select>
                        </ion-item>
                    </div>
                    <ion-item>
                        <ion-label position="stacked">フリーワード検索</ion-label>
                        <ion-input v-model="searchKeyword" placeholder="名前や町名で検索" @ionInput="onSearchInput"></ion-input>
                    </ion-item>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <ion-chip color="primary">
                            <ion-label>表示件数: {{ filteredDonors.length }}</ion-label>
                        </ion-chip>
                    </div>
                </div>
                
                <!-- ローディング表示 -->
                <div v-if="loading" class="loading">
                    <ion-spinner></ion-spinner>
                    <p>データを読み込んでいます...</p>
                </div>
                
                <!-- エラー表示 -->
                <div v-if="error" class="error">
                    <p>{{ error }}</p>
                    <ion-button @click="loadData" color="primary">再読み込み</ion-button>
                </div>
                
                <!-- 花板表示 -->
                <div v-if="!loading && !error" class="hanaban-container">
                    <div class="hanaban-grid">
                        <div v-for="donor in displayDonors" :key="donor.id" class="hanashi-card">
                            <div class="town-name">{{ donor.townName }}</div>
                            <div v-if="donor.position" class="position-title">{{ donor.position }}</div>
                            <div class="person-name">{{ donor.name }}殿</div>
                            <div class="amount">{{ donor.amountKanji }}</div>
                        </div>
                    </div>
                </div>
            </ion-content>
        </ion-app>
    </div>

    <script>
        // 設定定数
        const CONFIG = {
            SPREADSHEET_ID: '1JUmatTUZADKRnaSXLUAQBVEbNU-dGlql',
            SHEET_NAME: 'R7御花',
            CALLIGRAPHY_FONT: 'Yuji Syuku, Noto Serif JP, serif'
        };
        
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    donors: [],
                    loading: true,
                    error: null,
                    searchTown: '',
                    searchAmount: '',
                    searchKeyword: '',
                    debouncedKeyword: '',
                    debounceTimeout: null
                };
            },
            computed: {
                uniqueTowns() {
                    const towns = [...new Set(this.donors.map(donor => donor.townName))];
                    return towns.sort((a, b) => {
                        const aCategory = this.getAreaCategory(a);
                        const bCategory = this.getAreaCategory(b);
                        if (aCategory !== bCategory) {
                            return aCategory - bCategory;
                        }
                        return a.localeCompare(b);
                    });
                },
                uniqueAmounts() {
                    const amounts = [...new Set(this.donors.map(donor => donor.amount))];
                    return amounts.sort((a, b) => b - a);
                },
                filteredDonors() {
                    let filtered = this.donors;
                    
                    // 町名フィルタ
                    if (this.searchTown) {
                        filtered = filtered.filter(donor => donor.townName === this.searchTown);
                    }
                    
                    // 金額フィルタ（完全一致）
                    if (this.searchAmount) {
                        filtered = filtered.filter(donor => donor.amount === this.searchAmount);
                    }
                    
                    // フリーワード検索（デバウンス済み）
                    if (this.debouncedKeyword) {
                        const keyword = this.debouncedKeyword.toLowerCase();
                        filtered = filtered.filter(donor => 
                            donor.name.toLowerCase().includes(keyword) ||
                            donor.townName.toLowerCase().includes(keyword) ||
                            (donor.position && donor.position.toLowerCase().includes(keyword))
                        );
                    }
                    
                    return filtered;
                },
                displayDonors() {
                    // 3列レイアウト用の並び替え（右→中央→左→次の行）
                    const sorted = [...this.filteredDonors];
                    const result = [];
                    
                    for (let i = 0; i < sorted.length; i += 3) {
                        const row = sorted.slice(i, i + 3);
                        if (row.length >= 1) result.push(row[0]); // 右
                        if (row.length >= 2) result.push(row[1]); // 中央
                        if (row.length >= 3) result.push(row[2]); // 左
                    }
                    
                    return result;
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                onSearchInput(event) {
                    this.searchKeyword = event.target.value;
                    
                    // デバウンス処理
                    if (this.debounceTimeout) {
                        clearTimeout(this.debounceTimeout);
                    }
                    
                    this.debounceTimeout = setTimeout(() => {
                        this.debouncedKeyword = this.searchKeyword;
                    }, 300);
                },
                
                async loadData() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const csvUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`;
                        
                        const response = await fetch(csvUrl);
                        if (!response.ok) {
                            throw new Error('データの取得に失敗しました');
                        }
                        
                        const csvText = await response.text();
                        this.parseCsvData(csvText);
                        
                    } catch (err) {
                        this.error = 'データの読み込みに失敗しました: ' + err.message;
                        console.error('Error loading data:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                
                parseCsvData(csvText) {
                    const lines = csvText.split('\n');
                    const donors = [];
                    
                    // ヘッダー行をスキップして処理
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const columns = this.parseCsvLine(line);
                        if (columns.length < 12) continue;
                        
                        // C列:町名, D列:役職名, E列:御芳名, F列:金額, K列:花板不掲載, L列:花板表示順
                        const townName = columns[2] || '';
                        const position = columns[3] || '';
                        const name = columns[4] || '';
                        const amountStr = columns[5] || '';
                        const hideFlag = columns[10] || '';
                        const displayOrder = columns[11] || '';
                        
                        // 花板不掲載フラグが1の場合はスキップ
                        if (hideFlag === '1') continue;
                        
                        // 金額の処理
                        const amount = this.parseAmount(amountStr);
                        if (!amount || !name.trim()) continue;
                        
                        donors.push({
                            id: i,
                            townName: townName.replace(/"/g, ''),
                            position: position.replace(/"/g, '').trim() || null,
                            name: name.replace(/"/g, ''),
                            amount: amount,
                            amountKanji: this.convertToKanji(amount),
                            displayOrder: displayOrder ? parseFloat(displayOrder) : null
                        });
                    }
                    
                    // ソート処理
                    this.donors = this.sortDonors(donors);
                },
                
                parseCsvLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    
                    return result;
                },
                
                parseAmount(amountStr) {
                    const cleaned = amountStr.replace(/[¥,]/g, '').replace(/"/g, '');
                    const amount = parseInt(cleaned);
                    return isNaN(amount) ? null : amount;
                },
                
                convertToKanji(amount) {
                    const kanjiMap = {
                        50000: '金伍萬圓也',
                        30000: '金參萬圓也',
                        20000: '金弐萬圓也',
                        10000: '金壱萬圓也',
                        7000: '金七千圓也',
                        5000: '金伍千圓也',
                        3000: '金參千圓也',
                        2000: '金弐千圓也',
                        1000: '金千圓也'
                    };
                    
                    return kanjiMap[amount] || `金${amount.toLocaleString()}圓也`;
                },
                
                getAreaCategory(townName) {
                    if (townName === '並松町') return 0; // 最優先
                    if (townName.endsWith('町')) return 1;
                    if (townName.endsWith('市')) return 2;
                    if (townName.match(/[都道府県]$/)) return 3;
                    return 4; // その他
                },
                
                sortDonors(donors) {
                    return donors.sort((a, b) => {
                        // 1. 金額の高い順
                        if (a.amount !== b.amount) {
                            return b.amount - a.amount;
                        }
                        
                        // 2. エリア区分の順
                        const aCategory = this.getAreaCategory(a.townName);
                        const bCategory = this.getAreaCategory(b.townName);
                        if (aCategory !== bCategory) {
                            return aCategory - bCategory;
                        }
                        
                        // 3. 花板表示順の指定順
                        if (a.displayOrder !== null && b.displayOrder !== null) {
                            if (a.displayOrder !== b.displayOrder) {
                                return a.displayOrder - b.displayOrder;
                            }
                        } else if (a.displayOrder !== null) {
                            return -1;
                        } else if (b.displayOrder !== null) {
                            return 1;
                        }
                        
                        // 4. 町名順（文字コード順）
                        return a.townName.localeCompare(b.townName);
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
