<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»¤å’Œä¸ƒå¹´åº¦ ä¸¦æ¾ç”ºè‹¥é ­ å¾¡èŠ±å¾¡èŠ³å</title>
    
    <!-- Ionic Framework -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Google Fonts - Yuji Syuku -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Noto+Serif+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* è¨­å®šå®šæ•° */
        :root {
            --calligraphy-font: 'Yuji Syuku', 'Noto Serif JP', serif;
            --background-color: #f5f5dc;
            --paper-color: #faf0e6;
            --text-color: #2c1810;
            --red-accent: #cc3333;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* èŠ±æ¿ã‚«ãƒ¼ãƒ‰å†…ã®ã¿æ¯›ç­†ãƒ•ã‚©ãƒ³ãƒˆ */
        .hanashi-card {
            font-family: var(--calligraphy-font) !important;
        }
        
        .search-container {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .search-toggle {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background: #3880ff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .search-content {
            padding: 1rem;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .search-content.collapsed {
            max-height: 0;
            padding: 0 1rem;
        }
        
        .search-content.expanded {
            max-height: 500px;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .hanaban-container {
            padding: 1rem;
            background-color: var(--background-color);
        }
        
        .hanaban-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            direction: rtl; /* å³ã‹ã‚‰å·¦ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        }
        
        .hanashi-card {
            background: var(--paper-color);
            border: 2px solid var(--red-accent);
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            min-height: 420px;
            aspect-ratio: 3/4;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(204, 51, 51, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(204, 51, 51, 0.1) 0%, transparent 20%),
                linear-gradient(45deg, rgba(204, 51, 51, 0.05) 25%, transparent 25%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            direction: ltr; /* ã‚«ãƒ¼ãƒ‰å†…ã¯å·¦ã‹ã‚‰å³ã«æˆ»ã™ */
        }
        
        .town-name {
            font-size: 1.35rem;
            color: var(--text-color);
            margin-bottom: 0.8rem;
            text-align: center;
            font-weight: 700;
        }
        
        .name-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 0.5rem;
            height: 240px;
            margin: 1.5rem auto;
        }
        
        .position-title {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 1.2rem;
            color: var(--text-color);
            font-weight: 600;
            text-combine-upright: all;
        }
        
        .person-name {
            font-size: 2.7rem;
            font-weight: 900;
            color: var(--text-color);
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.15em;
            text-combine-upright: all;
        }
        
        .amount {
            position: absolute;
            right: 1.5rem;
            top: 3rem;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 1.5rem;
            color: var(--text-color);
            font-weight: 700;
            letter-spacing: 0.08em;
            text-combine-upright: all;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #cc3333;
            font-size: 1.1rem;
        }
        
        .chevron {
            transition: transform 0.3s ease;
        }
        
        .chevron.rotated {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .hanaban-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .hanashi-card {
                min-height: 360px;
                padding: 1.2rem;
            }
            
            .person-name {
                font-size: 2.3rem;
            }
            
            .name-container {
                height: 200px;
                margin: 1.2rem auto;
            }
            
            .amount {
                font-size: 1.3rem;
                top: 2.5rem;
                right: 1.2rem;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .search-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <ion-app>
            <ion-header>
                <ion-toolbar color="primary">
                    <ion-title>ä»¤å’Œä¸ƒå¹´åº¦ ä¸¦æ¾ç”ºè‹¥é ­ å¾¡èŠ±å¾¡èŠ³å</ion-title>
                </ion-toolbar>
            </ion-header>
            
            <ion-content>
                <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
                <div class="search-container">
                    <div class="search-toggle" @click="toggleSearch">
                        <span>ğŸ” æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿</span>
                        <ion-icon name="chevron-down" :class="{ 'chevron': true, 'rotated': searchExpanded }"></ion-icon>
                    </div>
                    <div :class="{ 'search-content': true, 'expanded': searchExpanded, 'collapsed': !searchExpanded }">
                        <div class="search-grid">
                            <ion-item>
                                <ion-label position="stacked">ç”ºåã§çµã‚Šè¾¼ã¿</ion-label>
                                <ion-select v-model="searchTown" placeholder="ç”ºåã‚’é¸æŠ" @ionChange="onTownChange">
                                    <ion-select-option value="">ã™ã¹ã¦è¡¨ç¤º</ion-select-option>
                                    <ion-select-option v-for="town in uniqueTowns" :key="town" :value="town">
                                        {{ town }}
                                    </ion-select-option>
                                </ion-select>
                            </ion-item>
                            <ion-item>
                                <ion-label position="stacked">é‡‘é¡ã§çµã‚Šè¾¼ã¿</ion-label>
                                <ion-select v-model="searchAmount" placeholder="é‡‘é¡ã‚’é¸æŠ" @ionChange="onAmountChange">
                                    <ion-select-option value="">ã™ã¹ã¦è¡¨ç¤º</ion-select-option>
                                    <ion-select-option v-for="amount in uniqueAmounts" :key="amount" :value="amount">
                                        {{ amount.toLocaleString() }}å††
                                    </ion-select-option>
                                </ion-select>
                            </ion-item>
                        </div>
                        <ion-item>
                            <ion-label position="stacked">ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</ion-label>
                            <ion-input v-model="searchKeyword" placeholder="åå‰ã‚„ç”ºåã§æ¤œç´¢" @ionInput="onSearchInput"></ion-input>
                        </ion-item>
                        <div style="margin-top: 0.5rem; text-align: center;">
                            <ion-chip color="primary">
                                <ion-label>è¡¨ç¤ºä»¶æ•°: {{ filteredDonors.length }}</ion-label>
                            </ion-chip>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                <div v-if="loading" class="loading">
                    <ion-spinner></ion-spinner>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>
                
                <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                <div v-if="error" class="error">
                    <p>{{ error }}</p>
                    <ion-button @click="loadData" color="primary">å†èª­ã¿è¾¼ã¿</ion-button>
                </div>
                
                <!-- èŠ±æ¿è¡¨ç¤º -->
                <div v-if="!loading && !error" class="hanaban-container">
                    <div class="hanaban-grid">
                        <div v-for="donor in filteredDonors" :key="donor.id" class="hanashi-card">
                            <div class="town-name">{{ donor.townName }}</div>
                            <div class="name-container">
                                <div v-if="donor.position" class="position-title">{{ donor.position }}</div>
                                <div class="person-name">{{ donor.name }} æ®¿</div>
                            </div>
                            <div class="amount">{{ donor.amountKanji }}</div>
                        </div>
                    </div>
                </div>
            </ion-content>
        </ion-app>
    </div>

    <script>
        // è¨­å®šå®šæ•°
        const CONFIG = {
            SPREADSHEET_ID: '1JUmatTUZADKRnaSXLUAQBVEbNU-dGlql',
            SHEET_NAME: 'R7å¾¡èŠ±',
            CALLIGRAPHY_FONT: 'Yuji Syuku, Noto Serif JP, serif'
        };
        
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    donors: [],
                    loading: true,
                    error: null,
                    searchTown: '',
                    searchAmount: '',
                    searchKeyword: '',
                    debouncedKeyword: '',
                    debounceTimeout: null,
                    searchExpanded: false
                };
            },
            computed: {
                uniqueTowns() {
                    const towns = [...new Set(this.donors.map(donor => donor.townName))];
                    return towns.sort((a, b) => {
                        const aCategory = this.getAreaCategory(a);
                        const bCategory = this.getAreaCategory(b);
                        if (aCategory !== bCategory) {
                            return aCategory - bCategory;
                        }
                        return a.localeCompare(b);
                    });
                },
                uniqueAmounts() {
                    const amounts = [...new Set(this.donors.map(donor => donor.amount))];
                    return amounts.sort((a, b) => b - a);
                },
                filteredDonors() {
                    let filtered = [...this.donors];
                    
                    // ç”ºåãƒ•ã‚£ãƒ«ã‚¿
                    if (this.searchTown) {
                        filtered = filtered.filter(donor => donor.townName === this.searchTown);
                    }
                    
                    // é‡‘é¡ãƒ•ã‚£ãƒ«ã‚¿
                    if (this.searchAmount) {
                        filtered = filtered.filter(donor => donor.amount === this.searchAmount);
                    }
                    
                    // ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹æ¸ˆã¿ï¼‰
                    if (this.debouncedKeyword) {
                        const keyword = this.debouncedKeyword.toLowerCase();
                        filtered = filtered.filter(donor => 
                            donor.name.toLowerCase().includes(keyword) ||
                            donor.townName.toLowerCase().includes(keyword) ||
                            (donor.position && donor.position.toLowerCase().includes(keyword))
                        );
                    }
                    
                    return filtered;
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                toggleSearch() {
                    this.searchExpanded = !this.searchExpanded;
                },
                
                onTownChange(event) {
                    this.searchTown = event.detail.value;
                },
                
                onAmountChange(event) {
                    this.searchAmount = event.detail.value;
                },
                
                onSearchInput(event) {
                    this.searchKeyword = event.detail.value;
                    
                    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
                    if (this.debounceTimeout) {
                        clearTimeout(this.debounceTimeout);
                    }
                    
                    this.debounceTimeout = setTimeout(() => {
                        this.debouncedKeyword = this.searchKeyword;
                    }, 300);
                },
                
                async loadData() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const csvUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`;
                        
                        const response = await fetch(csvUrl);
                        if (!response.ok) {
                            throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                        
                        const csvText = await response.text();
                        this.parseCsvData(csvText);
                        
                    } catch (err) {
                        this.error = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
                        console.error('Error loading data:', err);
                    } finally {
                        this.loading = false;
                    }
                },
                
                parseCsvData(csvText) {
                    const lines = csvText.split('\n');
                    const donors = [];
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å‡¦ç†
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const columns = this.parseCsvLine(line);
                        if (columns.length < 12) continue;
                        
                        // Cåˆ—:ç”ºå, Dåˆ—:å½¹è·å, Eåˆ—:å¾¡èŠ³å, Fåˆ—:é‡‘é¡, Kåˆ—:èŠ±æ¿ä¸æ²è¼‰, Låˆ—:èŠ±æ¿è¡¨ç¤ºé †
                        const townName = columns[2] || '';
                        const position = columns[3] || '';
                        const name = columns[4] || '';
                        const amountStr = columns[5] || '';
                        const hideFlag = columns[10] || '';
                        const displayOrder = columns[11] || '';
                        
                        // èŠ±æ¿ä¸æ²è¼‰ãƒ•ãƒ©ã‚°ãŒ1ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (hideFlag === '1') continue;
                        
                        // é‡‘é¡ã®å‡¦ç†
                        const amount = this.parseAmount(amountStr);
                        if (!amount || !name.trim()) continue;
                        
                        donors.push({
                            id: i,
                            townName: townName.replace(/"/g, ''),
                            position: position.replace(/"/g, '').trim() || null,
                            name: name.replace(/"/g, ''),
                            amount: amount,
                            amountKanji: this.convertToKanji(amount),
                            displayOrder: displayOrder ? parseFloat(displayOrder) : null
                        });
                    }
                    
                    // ã‚½ãƒ¼ãƒˆå‡¦ç†
                    this.donors = this.sortDonors(donors);
                },
                
                parseCsvLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current);
                    
                    return result;
                },
                
                parseAmount(amountStr) {
                    const cleaned = amountStr.replace(/[Â¥,]/g, '').replace(/"/g, '');
                    const amount = parseInt(cleaned);
                    return isNaN(amount) ? null : amount;
                },
                
                convertToKanji(amount) {
                    const kanjiMap = {
                        50000: 'é‡‘ä¼è¬åœ“ä¹Ÿ',
                        30000: 'é‡‘åƒè¬åœ“ä¹Ÿ',
                        20000: 'é‡‘å¼è¬åœ“ä¹Ÿ',
                        10000: 'é‡‘å£±è¬åœ“ä¹Ÿ',
                        7000: 'é‡‘ä¸ƒåƒåœ“ä¹Ÿ',
                        5000: 'é‡‘ä¼åƒåœ“ä¹Ÿ',
                        3000: 'é‡‘åƒåƒåœ“ä¹Ÿ',
                        2000: 'é‡‘å¼åƒåœ“ä¹Ÿ',
                        1000: 'é‡‘åƒåœ“ä¹Ÿ'
                    };
                    
                    return kanjiMap[amount] || `é‡‘${amount.toLocaleString()}åœ“ä¹Ÿ`;
                },
                
                getAreaCategory(townName) {
                    if (townName === 'ä¸¦æ¾ç”º') return 0; // æœ€å„ªå…ˆ
                    if (townName.endsWith('ç”º')) return 1;
                    if (townName.endsWith('å¸‚')) return 2;
                    if (townName.match(/[éƒ½é“åºœçœŒ]$/)) return 3;
                    return 4; // ãã®ä»–
                },
                
                sortDonors(donors) {
                    return donors.sort((a, b) => {
                        // 1. é‡‘é¡ã®é«˜ã„é †
                        if (a.amount !== b.amount) {
                            return b.amount - a.amount;
                        }
                        
                        // 2. ã‚¨ãƒªã‚¢åŒºåˆ†ã®é †
                        const aCategory = this.getAreaCategory(a.townName);
                        const bCategory = this.getAreaCategory(b.townName);
                        if (aCategory !== bCategory) {
                            return aCategory - bCategory;
                        }
                        
                        // 3. èŠ±æ¿è¡¨ç¤ºé †ã®æŒ‡å®šé †
                        if (a.displayOrder !== null && b.displayOrder !== null) {
                            if (a.displayOrder !== b.displayOrder) {
                                return a.displayOrder - b.displayOrder;
                            }
                        } else if (a.displayOrder !== null) {
                            return -1;
                        } else if (b.displayOrder !== null) {
                            return 1;
                        }
                        
                        // 4. ç”ºåé †ï¼ˆæ–‡å­—ã‚³ãƒ¼ãƒ‰é †ï¼‰
                        return a.townName.localeCompare(b.townName);
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
